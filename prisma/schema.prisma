generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  engineType      = "library"
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [postgis, uuid_ossp(map: "uuid-ossp", schema: "extensions")]
}

model User {
  id                 String   @id @default(cuid())
  auth0Id            String   @unique
  email              String   @unique
  role               UserRole
  stripeCustomerId   String?  @unique
  isPaid             Boolean  @default(false)
  subscriptionTier   String?
  subscriptionStatus String? // "active", "canceled", "past_due", "none"
  createdAt          DateTime @default(now())
  bandProfile        Band?
  venueProfile       Venue?
}

model Band {
  id               String                    @id @default(cuid())
  userId           String                    @unique
  name             String
  bio              String?
  lat              Float?
  lng              Float?
  location         Unsupported("geography")?
  searchRadius     Int                       @default(50)
  media            Json? // Array of {url, type: "mp3"|"mp4", title}
  availability     Json? // {bookedDates: string[], blockedDates: string[]}
  negotiationPrefs Json? // {minRate, currency, openToNegotiate}
  audioUrlPreview  String?
  audioUrlFull     String?
  taxStatus        Boolean                   @default(false)
  user             User                      @relation(fields: [userId], references: [id])
  gigs             Gig[]

  @@index([location], type: Gist)
}

model Venue {
  id               String                    @id @default(cuid())
  userId           String                    @unique
  name             String
  bio              String?
  lat              Float?
  lng              Float?
  location         Unsupported("geography")?
  capacity         Int?
  media            Json? // Array of {url, type: "image"|"video", title}
  availability     Json? // {bookedDates: string[], blockedDates: string[]}
  negotiationPrefs Json? // {minRate, currency, openToNegotiate}
  gigs             Gig[]
  user             User                      @relation(fields: [userId], references: [id])

  @@index([location], type: Gist)
}

model Gig {
  id          String  @id @default(cuid())
  status      String  @default("PENDING")
  payout      Float
  contractUrl String?
  bandId      String
  venueId     String
  band        Band    @relation(fields: [bandId], references: [id])
  venue       Venue   @relation(fields: [venueId], references: [id])
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model spatial_ref_sys {
  srid      Int     @id
  auth_name String? @db.VarChar(256)
  auth_srid Int?
  srtext    String? @db.VarChar(2048)
  proj4text String? @db.VarChar(2048)
}

enum UserRole {
  BAND
  VENUE
}
