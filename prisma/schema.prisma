generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
  engineType      = "library"
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  directUrl  = env("DIRECT_URL")
  extensions = [postgis, uuid_ossp(map: "uuid-ossp")]
}

model User {
  id                 String   @id @default(cuid())
  auth0Id            String   @unique
  email              String   @unique
  role               UserRole
  stripeCustomerId   String?  @unique
  isPaid             Boolean  @default(false)
  subscriptionTier   String?
  subscriptionStatus String? // "active", "canceled", "past_due", "none"
  createdAt          DateTime @default(now())
  bandProfile        Band?
  venueProfile       Venue?
}

model Band {
  id               String                    @id @default(cuid())
  userId           String                    @unique
  name             String
  bio              String?
  lat              Float?
  lng              Float?
  location         Unsupported("geography")?
  searchRadius     Int                       @default(50)
  media            Json? // Array of {url, type: "mp3"|"mp4", title}
  availability     Json? // {bookedDates: string[], blockedDates: string[]}
  negotiationPrefs Json? // {minRate, currency, openToNegotiate}
  audioUrlPreview  String?
  audioUrlFull     String?
  taxStatus        Boolean                   @default(false)
  user             User                      @relation(fields: [userId], references: [id])
  gigs             Gig[]

  @@index([location], type: Gist)
}

model Venue {
  id               String                    @id @default(cuid())
  userId           String                    @unique
  name             String
  bio              String?
  lat              Float?
  lng              Float?
  location         Unsupported("geography")?
  capacity         Int?
  media            Json? // Array of {url, type: "image"|"video", title}
  availability     Json? // {bookedDates: string[], blockedDates: string[]}
  negotiationPrefs Json? // {minRate, currency, openToNegotiate}
  gigs             Gig[]
  user             User                      @relation(fields: [userId], references: [id])

  @@index([location], type: Gist)
}

model Gig {
  id           String         @id @default(cuid())
  title        String
  description  String?
  venueId      String
  bandId       String
  status       GigStatus      @default(DRAFT)
  date         DateTime
  totalAmount  Float
  platformFee  Float          @default(0)
  contractUrl  String?
  payoutStatus String?        @default("PENDING") // "PENDING", "PAID", "DISPUTED"
  band         Band           @relation(fields: [bandId], references: [id])
  venue        Venue          @relation(fields: [venueId], references: [id])
  offers       Offer[]
  history      OfferHistory[]
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
}

model Offer {
  id          String   @id @default(cuid())
  gigId       String
  amount      Float
  message     String?
  createdById String // Auth0 ID of the user who made the offer
  createdAt   DateTime @default(now())
  gig         Gig      @relation(fields: [gigId], references: [id])
}

model OfferHistory {
  id           String    @id @default(cuid())
  gigId        String
  fromStatus   GigStatus
  toStatus     GigStatus
  changedById  String // Auth0 ID
  changeReason String?
  timestamp    DateTime  @default(now())
  gig          Gig       @relation(fields: [gigId], references: [id])
}

enum GigStatus {
  DRAFT
  OFFER_SENT
  COUNTER_OFFER
  ACCEPTED
  REJECTED
  BOOKED
  COMPLETED
  CANCELLED
}

enum UserRole {
  BAND
  VENUE
}
